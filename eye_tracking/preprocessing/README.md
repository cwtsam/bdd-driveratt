
# Preprocessing pipeline
## Installation

1. Clone project and intialize submodules

   ```bash
   git clone https://github.com/teresa-canasbajo/bdd-driveratt
   git submodule update --init
   ```

2. Run Make file: generates a virtual environment (bdddriverattenv), runs requirements.pip with all required python packages and requirements for Pupil Labs.

   ```python
   make
   ```

3. You may need to install the following packages with sudo/root privileges:

   `cysignals`

   `pkg-config`

   `automake`

   `cmake`

   `python3-dev`

   `libglew-dev`

   `xorg-dev libglu1-mesa-dev` <-- needed for libglew

   `libportaudio2` <-- for pyaudio

   `portaudio19-dev` <-- for pyaudio

   `pyaudio`

## Instructions of use

We want to acknowledge the work of behinger/etcomp repository (https://github.com/behinger/etcomp) of which we based the organizational structure of the code along with a few functions.

```python
from eye_tracking.preprocessing.functions.et_preprocess import preprocess_et
data = preprocess_et(subject='', datapath='/media/whitney/New Volume/Teresa/bdd-driveratt/demo')
```

preprocess_et outputs three dataframes: etsamples, etmsgs, etevents that are saved into your data directory /preprocessed

### Event detector:

In this implementation, fixations, blinks, saccades are detected & the results are saved into your data directory /preprocessed:
- the output generated by calling the pupil api to detect fixations & blinks 
- etevents compiles all 3 event types & specifies relevant attributes
- etsamples classifies each gaze datum as an event type

### Surface detector:

We've created a new implementation of the April tags package. The main maker detector is in manual_detection.py, that runs using the april_tags package: https://github.com/pupil-labs/apriltags

To install: pip install pupil-apriltags

Make sure to update (1) tags & (2) tags_corner_attribute parameters in detect_tags_and_surfaces() to detect surface.
Current version detects 1 surface. 
If there are multiple surfaces, turn off surface detector by making surfaceMap False in import_pl()

Frames from world recording are saved into your data directory /frames. Note that it may take some time to create.

Make createSurfaceFrame True in detect_tags_and_surfaces() to save frames annotated with surfaces into your data directory /frames/surface_frames.
Note that it may take some time to create.

### IDE:
This code has been built and modified using Pycharm.
Mark the following directories as source root (1) bdd-driveratt & (2) bdd-driveratt/eye_tracking/analysis/lib/pupil/pupil_src/shared_modules for the paths to work. 
Otherwise you may need to add the paths in another way.

### Installing Cysignals in Ubuntu
The code to install cysignals has been removed from the Makefile to make it accessible by Ubuntu/Mac/Windows. 
To install in Ubuntu: 
1. Add cysignals in line 30.

2. Add the following code to makefile:
```
cysignalssrc = ${installfolder}/build/src_cysignals

${cysignalssrc}:
		git clone https://github.com/sagemath/cysignals ${cysignalssrc}

cysignals: ${VENV} ${cysignalssrc}
		echo 'trying to install cysignals..' 
		cd ${cysignalssrc} && \
		sudo apt-get install python3-sphinx && \
		make configure && \
		make && \
		make install && \
		echo 'installed cysignals' 

``